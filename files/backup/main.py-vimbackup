#! /usr/bin/env python3

from mirai.event.external import 
from mirai import Mirai, MessageChain, Group, Plain, Image
import asyncio
import time
import os
import re
import random
from urllib import request

authKey = "MeuPasswd"
qq = 1291517893

app = Mirai(f"mirai://192.168.3.98:8080/?authKey={authKey}&qq={qq}", websocket=True)
#app = Mirai(f"mirai://127.0.0.1:8080/?authKey={authKey}&qq={qq}", websocket=True)

arr = list()
thre = 0
badlan = ['SB', 'sb', 'å‚»é€¼', 'jb', 'é¸¡å·´', 'æ’’å¸', 'æ™ºéšœ', 'zz', 'mdzz', 'è„‘æ®‹', 'CAO', 'cao', 'æ“', 'è‰', 'è‰¹', 'æˆ‘æ—¥', 'ä½ ğŸ´', 'ğŸ´å‘¢', 'faceå‘¢', 'å¦ˆå–æ‰¹', 'nm', 'ä½ å¦ˆ', 'è‰æ‹Ÿé©¬', 'é€¼é‡Œ', 'å±„']
withelist = ['nmap', 'zenmap', ':help', ':ping', ':image', ':zuan']
groupid = [1091328046, 830229301]

#@app.onStage("end")
#async def TimeSay(app: Mirai):
#    sleeptime = [14400, 7200, 4800, 4800, 12000, 9600, 4800]
#    while True:
#        TIME = int(time.strftime("%H%M%S", time.localtime(time.time())))
#        print(TIME)
#        if TIME in range (0, 6):
#            say = "æ²¡æƒ³åˆ°å§!æˆ‘æ‰æ˜¯ç†¬å¤œå† å†›~"
#            i = 0
#        elif TIME in range(6, 9):
#            say = "æ—©ä¸Šå¥½~"
#            i = 1
#        elif TIME in range(9, 11):
#            say = "ä¸Šåˆå¥½~"
#            i = 2
#        elif TIME in range(11, 13):
#            say = "ä¸­åˆå¥½~"
#            i = 3
#        elif TIME in range(13, 18):
#            say = "ä¸‹åˆå¥½~"
#            i = 4
#        elif TIME in range(18, 22):
#            say = "æ™šä¸Šå¥½~"
#            i = 5
#        else:
#            say = "ä¸æ—©äº†ï¼Œè¯¥ç¡äº†ï¼Œæ™šå®‰~"
#            i = 6
#
#        for group in groupid:
#            await app.sendGroupMessage(
#                group,
#                [
#                    Plain(text=f"{say}")
#                    ]
#                )
#        print(f"{TIME}ç‚¹å·²æ”¾é€")
#        time.sleep(sleeptime[i])
#        if i == 6:
#            i = 0

@app.receiver("GroupMessage")
async def event_gm(app: Mirai, message: MessageChain, group: Group):

    messages = MessageChain.toString(self=message)
    
    if group.id == 1091328046 and messages not in withelist:
        if len(arr) < 5:
            arr.append(messages)
        print(arr)

        if len(arr) >= 5:
            i = 0
            while i < 5:
                print(i)
                global thre
                elem = arr[i]
                freq = arr.count(elem)
                if freq >= 3:
                    if thre == 0:
                        await app.sendGroupMessage(
                                group,
                                [
                                    Plain(text="ä¸è¦åˆ·å±å“¦!")
                                    ]
                                )
                        thre = 1
                        arr.clear()
                        break
                    if thre == 1:
                        await app.sendGroupMessage(
                                group,
                                [
                                    Plain(text="ä¸å¬è¯?å£çƒä¼ºå€™!")
                                    ]
                                )
                        thre = 0
                        arr.clear()
                        break
                    print(thre)
                i = i + 1
            arr.clear()

    if messages not in withelist:
        for badword in badlan:
            if re.search(badword, messages) != None:
                await app.sendGroupMessage(
                        group,
                        [
                            Plain(text="æ³¨æ„æ–‡æ˜ç”¨è¯­!")
                            ]
                        )

    if messages == ":zuan":
        response = request.urlopen("https://nmsl.shadiao.app/api.php?level=min&lang=zh_cn")
        zuan = response.read()
        zuan = zuan.decode('utf-8')
        await app.sendGroupMessage(
                group,
                [
                    Plain(text=zuan)
                    ]
                )

    if re.search("éª‚ä»–", messages) != None:
        await app.sendGroupMessage(
                group,
                [
                    Plain(text="ç¥–å®‰æ˜¯ä¸€ç§ä¸è‡ªä¿¡çš„è¡¨ç°!")
                    ]
                )

    if re.search("éª‚æˆ‘", messages) != None:
        await app.sendGroupMessage(
                group,
                [
                    Plain(text="è¿˜æœ‰è¿™ç§å¥‡æ€ªéœ€æ±‚çš„äºº!")
                    ]
                )

    if messages == ":image":
        num = random.randint(0, 15)
        await app.sendGroupMessage(
                group,
                [
                    Image.fromFileSystem(f"images/{num}.jpg")
                    ]
                )

    if re.match("^:ping", messages) != None:
        
        r = re.match(":ping ((25[0-5])|(2[0-4]d)|(1dd)|([1-9]d)|d)(.((25[0-5])|(2[0-4]d)|(1dd)|([1-9]d)|d)){3}", messages)
        e = re.match(":ping [a-zA-Z0-9][-a-zA-Z0-9]{0,62}(.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+.?", messages)

        if r != None or e != None:

            resuatl = str()
            messages = list(messages)
            messages.pop(0)
            messages = ''.join(messages)
            command = os.popen(f"{messages} -c 4")
            restr = command.readlines()
            for i in restr:
                resuatl += i

            await app.sendGroupMessage(
                    group,
                    [
                        Plain(text=resuatl)
                        ]
                    )

        if r == None and e == None:
            await app.sendGroupMessage(
                    group,
                    [
                        Plain(text=
"""
æ­£ç¡®ç”¨æ³•:
:ping IPoråŸŸå
ä¸€å®šè¦å¡«å†™æ­£ç¡®çš„IPæˆ–åŸŸåå“¦!
""")
                        ]
                    )

    if messages  == ":help":
        await app.sendGroupMessage(
                group,
                [
                    Plain(text=
"""
ç”¨æ³•: :[æŒ‡ä»¤]

:image      å‘é€å›¾ç‰‡
:ping       å°±æ˜¯pingå˜›
:zuan       å˜´è‡­ä¸€ä¸‹
:help       æ˜¾ç¤ºæ­¤å¸®åŠ©åˆ—è¡¨

ä¸ºä»€ä¹ˆè¦ç”¨â€œ:â€ï¼Ÿ
ä¾¿äºè¾¨è¯†
               """) 
                    ]
                )

if __name__ == "__main__":
#    group = 1091328046
    app.run()
