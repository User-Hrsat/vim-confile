#! /usr/bin/env python3

from mirai.event.external import 
from mirai import Mirai, MessageChain, Group, Plain, Image
import asyncio
import time
import os
import re
import random
from urllib import request

authKey = "MeuPasswd"
qq = 1291517893

app = Mirai(f"mirai://192.168.3.98:8080/?authKey={authKey}&qq={qq}", websocket=True)
#app = Mirai(f"mirai://127.0.0.1:8080/?authKey={authKey}&qq={qq}", websocket=True)

arr = list()
thre = 0
badlan = ['SB', 'sb', '傻逼', 'jb', '鸡巴', '撒币', '智障', 'zz', 'mdzz', '脑残', 'CAO', 'cao', '操', '草', '艹', '我日', '你🐴', '🐴呢', 'face呢', '妈卖批', 'nm', '你妈', '草拟马', '逼里', '屄']
withelist = ['nmap', 'zenmap', ':help', ':ping', ':image', ':zuan']
groupid = [1091328046, 830229301]

#@app.onStage("end")
#async def TimeSay(app: Mirai):
#    sleeptime = [14400, 7200, 4800, 4800, 12000, 9600, 4800]
#    while True:
#        TIME = int(time.strftime("%H%M%S", time.localtime(time.time())))
#        print(TIME)
#        if TIME in range (0, 6):
#            say = "没想到吧!我才是熬夜冠军~"
#            i = 0
#        elif TIME in range(6, 9):
#            say = "早上好~"
#            i = 1
#        elif TIME in range(9, 11):
#            say = "上午好~"
#            i = 2
#        elif TIME in range(11, 13):
#            say = "中午好~"
#            i = 3
#        elif TIME in range(13, 18):
#            say = "下午好~"
#            i = 4
#        elif TIME in range(18, 22):
#            say = "晚上好~"
#            i = 5
#        else:
#            say = "不早了，该睡了，晚安~"
#            i = 6
#
#        for group in groupid:
#            await app.sendGroupMessage(
#                group,
#                [
#                    Plain(text=f"{say}")
#                    ]
#                )
#        print(f"{TIME}点已放送")
#        time.sleep(sleeptime[i])
#        if i == 6:
#            i = 0

@app.receiver("GroupMessage")
async def event_gm(app: Mirai, message: MessageChain, group: Group):

    messages = MessageChain.toString(self=message)
    
    if group.id == 1091328046 and messages not in withelist:
        if len(arr) < 5:
            arr.append(messages)
        print(arr)

        if len(arr) >= 5:
            i = 0
            while i < 5:
                print(i)
                global thre
                elem = arr[i]
                freq = arr.count(elem)
                if freq >= 3:
                    if thre == 0:
                        await app.sendGroupMessage(
                                group,
                                [
                                    Plain(text="不要刷屏哦!")
                                    ]
                                )
                        thre = 1
                        arr.clear()
                        break
                    if thre == 1:
                        await app.sendGroupMessage(
                                group,
                                [
                                    Plain(text="不听话?口球伺候!")
                                    ]
                                )
                        thre = 0
                        arr.clear()
                        break
                    print(thre)
                i = i + 1
            arr.clear()

    if messages not in withelist:
        for badword in badlan:
            if re.search(badword, messages) != None:
                await app.sendGroupMessage(
                        group,
                        [
                            Plain(text="注意文明用语!")
                            ]
                        )

    if messages == ":zuan":
        response = request.urlopen("https://nmsl.shadiao.app/api.php?level=min&lang=zh_cn")
        zuan = response.read()
        zuan = zuan.decode('utf-8')
        await app.sendGroupMessage(
                group,
                [
                    Plain(text=zuan)
                    ]
                )

    if re.search("骂他", messages) != None:
        await app.sendGroupMessage(
                group,
                [
                    Plain(text="祖安是一种不自信的表现!")
                    ]
                )

    if re.search("骂我", messages) != None:
        await app.sendGroupMessage(
                group,
                [
                    Plain(text="还有这种奇怪需求的人!")
                    ]
                )

    if messages == ":image":
        num = random.randint(0, 15)
        await app.sendGroupMessage(
                group,
                [
                    Image.fromFileSystem(f"images/{num}.jpg")
                    ]
                )

    if re.match("^:ping", messages) != None:
        
        r = re.match(":ping ((25[0-5])|(2[0-4]d)|(1dd)|([1-9]d)|d)(.((25[0-5])|(2[0-4]d)|(1dd)|([1-9]d)|d)){3}", messages)
        e = re.match(":ping [a-zA-Z0-9][-a-zA-Z0-9]{0,62}(.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+.?", messages)

        if r != None or e != None:

            resuatl = str()
            messages = list(messages)
            messages.pop(0)
            messages = ''.join(messages)
            command = os.popen(f"{messages} -c 4")
            restr = command.readlines()
            for i in restr:
                resuatl += i

            await app.sendGroupMessage(
                    group,
                    [
                        Plain(text=resuatl)
                        ]
                    )

        if r == None and e == None:
            await app.sendGroupMessage(
                    group,
                    [
                        Plain(text=
"""
正确用法:
:ping IPor域名
一定要填写正确的IP或域名哦!
""")
                        ]
                    )

    if messages  == ":help":
        await app.sendGroupMessage(
                group,
                [
                    Plain(text=
"""
用法: :[指令]

:image      发送图片
:ping       就是ping嘛
:zuan       嘴臭一下
:help       显示此帮助列表

为什么要用“:”？
便于辨识
               """) 
                    ]
                )

if __name__ == "__main__":
#    group = 1091328046
    app.run()
