#! /usr/bin/env python3.8

from mirai import Mirai, Image, Plain, MessageChain, Friend, Group, Member, Depend
import asyncio
import time
import os
import re
from devtools import debug

authKey = "MeuPasswd"
qq = 1291517893

app = Mirai(f"mirai://192.168.3.98:8080/?authKey={authKey}&qq={qq}", websocket=True)

arr = list()
thre = 0
badlan = ['SB', 'sb', 'å‚»é€¼', 'æ™ºéšœ', 'zz', 'mdzz', 'è„‘æ®‹', 'CAO', 'cao', 'æ“', 'è‰', 'è‰¹', 'æˆ‘æ—¥', 'ä½ ğŸ', 'faceå‘¢', 'å¦ˆå–æ‰¹']
@app.receiver("GroupMessage")
async def event_gm(app: Mirai, message: MessageChain, group: Group):

    messages = MessageChain.toString(self=message)

    if group.id == 1091328046:
        if len(arr) < 5:
            arr.append(messages)
        print(arr)

        if len(arr) >= 5:
            i = 0
            while i < 5:
                print(i)
                global thre
                elem = arr[i]
                freq = arr.count(elem)
                if freq >= 3:
                    if thre == 0:
                        await app.sendGroupMessage(
                                group,
                                [
                                    Plain(text="ä¸è¦åˆ·å±å“¦!")
                                    ]
                                )
                        thre = 1
                        arr.clear()
                        break
                    if thre == 1:
                        await app.sendGroupMessage(
                                group,
                                [
                                    Plain(text="ä¸å¬è¯?å£çƒä¼ºå€™!")
                                    ]
                                )
                        thre = 0
                        arr.clear()
                        break
                    print(thre)
                i = i + 1
            arr.clear()

    if messages in badlan:
        await app.sendGroupMessage(
            group,
            [
                Plain(text="æ³¨æ„æ–‡æ˜ç”¨è¯­!")
            ]
        )

    if messages == "/image":
        await app.sendGroupMessage(
            group,
            [
                Image.fromFileSystem("/home/hrsat/Pictures/A.gif")
            ]
        )

#    if group.id == 1091328046 and re.match("^/ping", messages) != None:
    if re.match("^/ping", messages) != None:
        
        r = re.match("/ping ((25[0-5])|(2[0-4]d)|(1dd)|([1-9]d)|d)(.((25[0-5])|(2[0-4]d)|(1dd)|([1-9]d)|d)){3}", messages)
        e = re.match("/ping [a-zA-Z0-9][-a-zA-Z0-9]{0,62}(.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+.?", messages)

        if r != None or e != None:

            resuatl = ''
            messages = list(messages)
            messages.pop(0)
            messages = ''.join(messages)
            command = os.popen(f"{messages} -c 4")
            restr = command.readlines()
            for line in restr:
                resuatl += restr

            await app.sendGroupMessage(
                    group,
                    [
                        Plain(text=resuatl)
                    ]
            )

        if r == None and e == None:

            await app.sendGroupMessage(
                    group,
                    [
                        Plain(text=
"""
æ­£ç¡®ç”¨æ³•:
/ping IPoråŸŸå
ä¸€å®šè¦å¡«å†™æ­£ç¡®çš„IPæˆ–åŸŸåå“¦!
""")
                    ]
            )
        
    if messages  == "/help":
        await app.sendGroupMessage(
            group,
            [
               Plain(text="""
ç”¨æ³•: /[æŒ‡ä»¤]

/image      å‘é€å›¾ç‰‡
/ping       å°±æ˜¯pingå˜›
/help       æ˜¾ç¤ºæ­¤å¸®åŠ©åˆ—è¡¨

ä¸ºä»€ä¹ˆè¦ç”¨â€œ/â€ï¼Ÿ
ä¾¿äºè¾¨è¯†,å¯èƒ½å¯¹æ¡Œé¢ç”¨æˆ·ä¸å¤ªå‹å¥½
               """) 
            ]
        )

if __name__ == "__main__":
    app.run()
